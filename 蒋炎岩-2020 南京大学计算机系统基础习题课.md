

# C 语言拾遗 (1): 机制

## 1.安装虚拟机

```bash
# 1.打开window cmd窗口，运行 命令 ,即可初始化一个centos系统
#Vagrant init centos/7    官方的太慢了，更改为中科大的源
vagrant init centos7 https://mirrors.ustc.edu.cn/centos-cloud/centos/7/vagrant/x86_64/images/CentOS-7.box
# 1.登录虚拟机
Vagrant ssh
# 2.切换root用户
su root
# 3.修改权限
[root@k8s-node1 vagrant]# vi /etc/ssh/sshd_config
#PermitRootLogin yes 
PasswordAuthentication yes
# 4.重启虚拟机
[root@k8s-node1 vagrant]# service sshd restart
Redirecting to /bin/systemctl restart sshd.servic
# 5.退出
[root@k8s-node1 vagrant]# exit
exit
[vagrant@k8s-node1 ~]$ exit
logout
Connection to 127.0.0.1 closed

# 6.固定虚拟机ip  修改 Vagrantfile
config.vm.network "private_network", ip: "192.168.56.10"
```

安装一些工具

```bash
yum install vim
yum install gcc
yum install gcc-c++ libstdc++-devel 
```



## 2.进入 C 语言之前：预编译

`#include <>` 指令

以下代码有什么区别？

```
#include <stdio.h>
#include "stdio.h"
```

------

一个是从本地目录优先加载，一个是直接从库加载

为什么在没有安装库时会发生错误？

```
#include <SDL2/SDL2.h>
```

------

你可能在书/阅读材料上了解过一些相关的知识

- 但更好的办法是阅读命令的日志
- `gcc --verbose a.c`

## 3.有趣的预编译

以下代码会输出什么？

- 为什么？

```c
#include <stdio.h>
int main() {
#if aa == bb
  printf("Yes\n");
#else
  printf("No\n");
#endif
}
```

`gcc --verbose a.c`

```bash
[root@localhost l1]# gcc --verbose a.c
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/lto-wrapper
Target: x86_64-redhat-linux
Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-linker-hash-style=gnu --enable-languages=c,c++,objc,obj-c++,java,fortran,ada,go,lto --enable-plugin --enable-initfini-array --disable-libgcj --with-isl=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/isl-install --with-cloog=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/cloog-install --enable-gnu-indirect-function --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux
Thread model: posix
gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
COLLECT_GCC_OPTIONS='-v' '-mtune=generic' '-march=x86-64'
 /usr/libexec/gcc/x86_64-redhat-linux/4.8.5/cc1 -quiet -v a.c -quiet -dumpbase a.c -mtune=generic -march=x86-64 -auxbase a -version -o /tmp/cce2ItfI.s
GNU C (GCC) version 4.8.5 20150623 (Red Hat 4.8.5-44) (x86_64-redhat-linux)
	compiled by GNU C version 4.8.5 20150623 (Red Hat 4.8.5-44), GMP version 6.0.0, MPFR version 3.1.1, MPC version 1.0.1
GGC heuristics: --param ggc-min-expand=63 --param ggc-min-heapsize=62335
ignoring nonexistent directory "/usr/lib/gcc/x86_64-redhat-linux/4.8.5/include-fixed"
ignoring nonexistent directory "/usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../x86_64-redhat-linux/include"
#include "..." search starts here:
#include <...> search starts here:
 /usr/lib/gcc/x86_64-redhat-linux/4.8.5/include
 /usr/local/include
 /usr/include
End of search list.
GNU C (GCC) version 4.8.5 20150623 (Red Hat 4.8.5-44) (x86_64-redhat-linux)
	compiled by GNU C version 4.8.5 20150623 (Red Hat 4.8.5-44), GMP version 6.0.0, MPFR version 3.1.1, MPC version 1.0.1
GGC heuristics: --param ggc-min-expand=63 --param ggc-min-heapsize=62335
Compiler executable checksum: 231b3394950636dbfe0428e88716bc73
COLLECT_GCC_OPTIONS='-v' '-mtune=generic' '-march=x86-64'
 as -v --64 -o /tmp/ccF1q9kr.o /tmp/cce2ItfI.s
GNU assembler version 2.27 (x86_64-redhat-linux) using BFD version version 2.27-43.base.el7
COMPILER_PATH=/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/:/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/:/usr/libexec/gcc/x86_64-redhat-linux/:/usr/lib/gcc/x86_64-redhat-linux/4.8.5/:/usr/lib/gcc/x86_64-redhat-linux/
LIBRARY_PATH=/usr/lib/gcc/x86_64-redhat-linux/4.8.5/:/usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../lib64/:/lib/../lib64/:/usr/lib/../lib64/:/usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../:/lib/:/usr/lib/
COLLECT_GCC_OPTIONS='-v' '-mtune=generic' '-march=x86-64'
 /usr/libexec/gcc/x86_64-redhat-linux/4.8.5/collect2 --build-id --no-add-needed --eh-frame-hdr --hash-style=gnu -m elf_x86_64 -dynamic-linker /lib64/ld-linux-x86-64.so.2 /usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../lib64/crt1.o /usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../lib64/crti.o /usr/lib/gcc/x86_64-redhat-linux/4.8.5/crtbegin.o -L/usr/lib/gcc/x86_64-redhat-linux/4.8.5 -L/usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../lib64 -L/lib/../lib64 -L/usr/lib/../lib64 -L/usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../.. /tmp/ccF1q9kr.o -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-redhat-linux/4.8.5/crtend.o /usr/lib/gcc/x86_64-redhat-linux/4.8.5/../../../../lib64/crtn.o
 # 编译后 多了一个 a.out 文件
[root@localhost l1]# ls
a.c  a.out
# 运行
[root@localhost l1]# ./a.out 
Yes
```

原因：

aa 和 bb 都未被定义，所以 aa==bb 相当于 null == null  结果为 true

## 4.宏定义与展开

### 宏展开：通过复制/粘贴改变代码的形态

- `#include` → 粘贴文件
- `aa`, `bb` → 粘贴符号

知乎问题：如何搞垮一个 OJ？

```bash
#define A "aaaaaaaaaa"
#define TEN(A) A A A A A A A A A A
#define B TEN(A)
#define C TEN(B)
#define D TEN(C)
#define E TEN(D)
#define F TEN(E)
#define G TEN(F)
int main() { puts(G); }
```

```bash
gcc b.c
[root@localhost l1]# ls
a.out  b.c
[root@localhost l1]# ./a.out
aaa...
...
# 长度 
[root@localhost l1]# ./a.out | wc
      1       1 10000001

# 大小
[root@localhost l1]# ll
total 9780
-rwxr-xr-x. 1 root root 10006688 Aug 16 14:09 a.out
-rw-r--r--. 1 root root      184 Aug 16 14:09 b.c
```

### 如何躲过 Online Judge 的关键字过滤？

```c
#define SYSTEM sys ## tem

[root@localhost l1]# vim a.c
 
#define A sys ## tem
int main(){
	A("echo hello");
}

[root@localhost l1]# gcc a.c
[root@localhost l1]# ./a.out 
hello
```

------

### 如何毁掉一个身边的同学？

> #define true (__LINE__ % 2 != 0)

```
#define true (__LINE__ % 2 != 0)
#include <stdio.h>
int main(){
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
        if(true) printf("yes %d\n",__LINE__);
}
```

隔行打印

```bash
[root@localhost l1]# gcc a.c
[root@localhost l1]# ./a.out 
yes 9
yes 11
yes 13
yes 15
yes 17
```

```c
#define s (((((((((((((((( 0
#define _ * 2)
#define X * 2 + 1)
static unsigned short stopwatch[] = {
  s _ _ _ _ _ X X X X X _ _ _ X X _ ,
  s _ _ _ X X X X X X X X X _ X X X ,
  s _ _ X X X _ _ _ _ _ X X X _ X X ,
  s _ X X _ _ _ _ _ _ _ _ _ X X _ _ ,
  s X X _ _ _ _ _ _ _ _ _ _ _ X X _ ,
  s X X _ X X X X X _ _ _ _ _ X X _ ,
  s X X _ _ _ _ _ X _ _ _ _ _ X X _ ,
  s X X _ _ _ _ _ X _ _ _ _ _ X X _ ,
  s _ X X _ _ _ _ X _ _ _ _ X X _ _ ,
  s _ _ X X X _ _ _ _ _ X X X _ _ _ ,
  s _ _ _ X X X X X X X X X _ _ _ _ ,
  s _ _ _ _ _ X X X X X _ _ _ _ _ _ , };
```

```bash
[root@localhost l1]# gcc -E d.c 
static unsigned short stopwatch[] = {
  (((((((((((((((( 0 * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) ,
  (((((((((((((((( 0 * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2 + 1) * 2 + 1) * 2 + 1) ,
  (((((((((((((((( 0 * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2 + 1) * 2 + 1) ,
  (((((((((((((((( 0 * 2) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) * 2) ,
  (((((((((((((((( 0 * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) ,
  (((((((((((((((( 0 * 2 + 1) * 2 + 1) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) ,
  (((((((((((((((( 0 * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) ,
  (((((((((((((((( 0 * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) ,
  (((((((((((((((( 0 * 2) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2 + 1) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2) * 2) ,
  (((((((((((((((( 0 * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) ,
  (((((((((((((((( 0 * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) ,
  (((((((((((((((( 0 * 2) * 2) * 2) * 2) * 2) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2 + 1) * 2) * 2) * 2) * 2) * 2) * 2) };

```

